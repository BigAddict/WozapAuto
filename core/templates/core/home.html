{% extends 'core/base.html' %}
{% load static %}
{# {% load component_tags %} #}

{% block title %}Dashboard - WozapAuto{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-xl) var(--space-lg);
    }
    
    .dashboard-header {
        margin-bottom: var(--space-2xl);
    }
    
    .dashboard-title {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0 0 var(--space-sm) 0;
    }
    
    .dashboard-subtitle {
        font-size: var(--font-size-base);
        color: var(--text-secondary);
        margin: 0;
    }
    
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-2xl);
    }
    
    .stat-card {
        background: var(--background-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: var(--space-xl);
        transition: var(--transition);
    }
    
    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .stat-card__icon {
        font-size: var(--font-size-3xl);
        margin-bottom: var(--space-md);
        display: block;
    }
    
    .stat-card__number {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--primary-color);
        margin: 0 0 var(--space-xs) 0;
    }
    
    .stat-card__label {
        font-size: var(--font-size-base);
        color: var(--text-secondary);
        margin: 0 0 var(--space-sm) 0;
    }
    
    .stat-card__change {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
    }
    
    .stat-card__change--positive {
        color: var(--success-color);
    }
    
    .stat-card__change--negative {
        color: var(--error-color);
    }
    
    .dashboard-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-2xl);
    }
    
    .action-card {
        background: var(--background-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: var(--space-xl);
        text-align: center;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .action-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
        border-color: var(--primary-color);
    }
    
    .action-card__icon {
        font-size: var(--font-size-4xl);
        margin-bottom: var(--space-lg);
        display: block;
    }
    
    .action-card__title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0 0 var(--space-sm) 0;
    }
    
    .action-card__description {
        font-size: var(--font-size-base);
        color: var(--text-secondary);
        margin: 0 0 var(--space-lg) 0;
        line-height: 1.6;
    }
    
    .recent-activity {
        background: var(--background-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .recent-activity__header {
        padding: var(--space-xl);
        border-bottom: 1px solid var(--border-color);
        background: var(--background-light);
    }
    
    .recent-activity__title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0;
    }
    
    .recent-activity__content {
        padding: var(--space-xl);
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-md) 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-item__icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: var(--border-radius-full);
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--font-size-lg);
        flex-shrink: 0;
    }
    
    .activity-item__content {
        flex: 1;
    }
    
    .activity-item__title {
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0 0 var(--space-xs) 0;
    }
    
    .activity-item__description {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin: 0;
    }
    
    .activity-item__time {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        flex-shrink: 0;
    }
    
    .empty-state {
        text-align: center;
        padding: var(--space-3xl) var(--space-xl);
        color: var(--text-secondary);
    }
    
    .empty-state__icon {
        font-size: 4rem;
        margin-bottom: var(--space-lg);
        opacity: 0.5;
    }
    
    .empty-state__title {
        font-size: var(--font-size-xl);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin: 0 0 var(--space-md) 0;
    }
    
    .empty-state__description {
        font-size: var(--font-size-base);
        color: var(--text-secondary);
        margin: 0 0 var(--space-lg) 0;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Landing hero adjustments */
    .hero-image {
        position: relative;
        min-height: 360px;
    }
    .hero-stats {
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(6px);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 0.75rem;
        box-shadow: var(--shadow);
    }
    .hero-stats .stat-item {
        text-align: center;
        padding: .5rem .75rem;
        min-width: 110px;
    }
    .hero-stats .stat-number {
        font-size: 1.35rem;
        font-weight: 700;
        line-height: 1.1;
    }
    .hero-stats .stat-label {
        font-size: .8rem;
        color: var(--text-secondary);
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: var(--space-lg) var(--space-md);
        }
        
        .dashboard-stats {
            grid-template-columns: 1fr;
        }
        
        .dashboard-actions {
            grid-template-columns: 1fr;
        }
        
        .stat-card,
        .action-card {
            padding: var(--space-lg);
        }
        
        .recent-activity__header,
        .recent-activity__content {
            padding: var(--space-lg);
        }
    }

    /* Responsive behavior for hero stats on mobile */
    @media (max-width: 991.98px) {
        .hero-stats {
            position: static;
            transform: none;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-top: .75rem;
        }
        .hero-stats .stat-item { min-width: 0; flex: 1; }
        .hero-stats .stat-number { font-size: 1.1rem; }
        .hero-section .row.align-items-center { min-height: 72vh; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% if user.is_authenticated %}
    <!-- Authenticated User Dashboard -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Welcome back, {{ user.first_name|default:user.username }}!</h1>
        <p class="dashboard-subtitle">Your WhatsApp AI Agent Platform Dashboard</p>
    </div>
    
    <!-- Dashboard Stats -->
    {% if total_connections > 0 %}
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-whatsapp text-primary fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-primary">{{ connection_status|default:'Disconnected' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Connection Status</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-chat-dots text-info fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-info">{{ messages_count|default:'0' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Messages</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-people text-success fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-success">{{ contacts_count|default:'0' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Contacts</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-robot text-warning fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-warning">0</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">AI Agents</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Business Statistics -->
    {% if business_profile %}
    <div class="row g-3 mb-4">
        <div class="col-12">
            <h4 class="mb-3">Business Overview - {{ business_profile.name }}</h4>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-cart text-primary fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-primary">{{ total_carts|default:'0' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Total Orders</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-cart-check text-success fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-success">{{ completed_carts|default:'0' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Completed Orders</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-calendar-check text-info fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-info">{{ total_appointments|default:'0' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Appointments</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-box text-warning fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-warning">{{ total_products|default:'0' }}</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Products</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Orders -->
    {% if recent_carts or recent_appointments %}
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Orders</h5>
                </div>
                <div class="card-body">
                    {% if recent_carts %}
                        {% for cart in recent_carts %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ cart.name|default:"Anonymous" }}</strong>
                                <br><small class="text-muted">{{ cart.total_items }} items</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ cart.status|yesno:'success,warning,danger,primary' }}">{{ cart.status|title }}</span>
                                <br><small>{{ cart.created_at|date:"M d" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No recent orders</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Appointments</h5>
                </div>
                <div class="card-body">
                    {% if recent_appointments %}
                        {% for appointment in recent_appointments %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ appointment.customer_name }}</strong>
                                <br><small class="text-muted">{{ appointment.service.name }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{% if appointment.status == 'confirmed' %}success{% elif appointment.status == 'pending' %}warning{% elif appointment.status == 'cancelled' %}danger{% else %}primary{% endif %}">{{ appointment.get_status_display }}</span>
                                <br><small>{{ appointment.booking_date|date:"M d" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No recent appointments</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
    
    {% else %}
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-whatsapp text-primary fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-primary">0</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">WhatsApp Connection</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-robot text-info fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-info">0</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">AI Agents</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card hover-lift">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3">
                        <i class="bi bi-chat-dots text-success fs-1"></i>
                    </div>
                    <div class="stat-value mb-2">
                        <h3 class="mb-0 text-success">0</h3>
                    </div>
                    <div class="stat-title mb-2">
                        <h6 class="text-muted mb-0">Messages Processed</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="row g-3 mb-4">
        {% if total_connections == 0 %}
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Setup Connection</h5>
                    <h6 class="card-subtitle text-muted">Connect your WhatsApp account</h6>
        </div>
                <div class="card-body">
                    <p>Connect your WhatsApp account to start using AI agents</p>
                        <button class="btn btn-primary" onclick="window.location.href='{% url 'connections:create' %}'">
                            <i class="bi-plus-circle me-2"></i>Create Connection
                        </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">AI Agents</h5>
                    <h6 class="card-subtitle text-muted">Coming Soon</h6>
                </div>
                <div class="card-body">
                    <p>Create and manage AI agents for automated responses</p>
                    <button class="btn btn-outline-secondary" disabled>
                        <i class="bi-robot me-2"></i>Coming Soon
                    </button>
                </div>
            </div>
        </div>
            </div>
            
    
    {% else %}
    <!-- Landing Page for Unauthenticated Users -->
    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center min-vh-75">
                <div class="col-lg-6">
                    <div class="hero-content">
                        <div class="hero-badge mb-3" data-aos="fade-down">
                            <span class="badge glass px-3 py-2">
                                <i class="bi bi-star-fill me-1"></i>Trusted by 10,000+ businesses
                            </span>
                        </div>
                        <h1 class="hero-title mb-4" data-aos="fade-up" data-aos-delay="200">
                            Transform Your Customer Service with 
                            <span class="text-gradient gradient-text-animated">AI-Powered</span> WhatsApp Agents
                        </h1>
                        <p class="hero-description mb-4" data-aos="fade-up" data-aos-delay="400">
                            Automate customer support, boost response times, and scale your business with intelligent WhatsApp bots that work 24/7.
                        </p>
                        <div class="hero-actions d-flex flex-column flex-sm-row gap-3 mb-3" data-aos="fade-up" data-aos-delay="600">
                            <a href="{% url 'signup' %}" class="btn btn-primary btn-lg px-4 py-3">
                                <i class="bi bi-rocket-takeoff me-2"></i>Start Free Trial
                            </a>
                            <a href="#demo" class="btn btn-outline-primary btn-lg px-4 py-3">
                                <i class="bi bi-play-circle me-2"></i>Watch Demo
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="hero-image" data-aos="fade-left" data-aos-delay="400">
                        <div class="floating-card card-1">
                            <div class="card-header d-flex align-items-center">
                                <div class="avatar me-2">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Customer Support</h6>
                                    <small class="text-muted">Online</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Hi! How can I help you today?</p>
                                <div class="message-bubble">
                                    <p class="mb-0">I need help with my order</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="floating-card card-2">
                            <div class="card-header d-flex align-items-center">
                                <div class="avatar me-2">
                                    <i class="bi bi-robot"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">AI Assistant</h6>
                                    <small class="text-muted">Responding...</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">I can help you with that! What's your order number?</p>
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats moved to the side of hero image for better fold fit -->
                        <div class="hero-stats" data-aos="fade-left" data-aos-delay="800">
                            <div class="stat-item">
                                <div class="stat-number">10K+</div>
                                <div class="stat-label">Active Users</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">99.9%</div>
                                <div class="stat-label">Uptime</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">24/7</div>
                                <div class="stat-label">Support</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for action cards
    document.querySelectorAll('.action-card').forEach(card => {
        card.addEventListener('click', function() {
            // Add click animation
            this.style.transform = 'scale(0.98)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
    
    // Animate stat numbers
    function animateNumbers() {
        document.querySelectorAll('.stat-card__number').forEach(element => {
            const finalNumber = element.textContent;
            const isPercentage = finalNumber.includes('%');
            const isPlus = finalNumber.includes('+');
            const numericValue = parseFloat(finalNumber.replace(/[^\d.]/g, ''));
            
            if (!isNaN(numericValue)) {
                let currentNumber = 0;
                const increment = numericValue / 50;
                const timer = setInterval(() => {
                    currentNumber += increment;
                    if (currentNumber >= numericValue) {
                        currentNumber = numericValue;
                        clearInterval(timer);
                    }
                    
                    let displayNumber = Math.floor(currentNumber);
                    if (isPercentage) displayNumber += '%';
                    if (isPlus) displayNumber = '+' + displayNumber;
                    
                    element.textContent = displayNumber;
                }, 30);
            }
        });
    }
    
    // Start animation when page loads
    setTimeout(animateNumbers, 500);
});
</script>
{% endblock %}