{% extends 'core/base.html' %}
{% load static %}

{% block title %}Reset Password - WozapAuto{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/account.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid account-page">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="surface-card surface-card--muted">
                <div class="surface-section__header">
                    <h4 class="mb-0">
                        <i class="bi bi-shield-lock me-2"></i>Reset Your Password
                    </h4>
                </div>
                <div>
                    <p class="text-muted mb-4">
                        Create a strong password to secure your account.
                    </p>
                    
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger" role="alert">
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="mb-3 {% if form.new_password1.errors %}form-group--error{% endif %}">
                            <label for="{{ form.new_password1.id_for_label }}" class="form-label">New Password</label>
                            <div class="password-input">
                                {{ form.new_password1 }}
                                <button type="button" class="password-input__toggle" aria-label="Show password" aria-pressed="false">
                                    <i class="bi bi-eye"></i>
                                    <span class="visually-hidden">Toggle password visibility</span>
                                </button>
                            </div>
                            {% if form.new_password1.errors %}
                                <div class="form-error mt-2">
                                    {% for error in form.new_password1.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="password-strength mt-3">
                                <div class="progress" style="height: 6px;">
                                    <div id="pwStrengthBar" class="progress-bar bg-danger" style="width: 0%"></div>
                                </div>
                                <small id="pwStrengthText" class="text-muted">Strength: Too weak</small>
                            </div>
                            <ul class="password-checklist small mt-2 list-unstyled">
                                <li id="req-length" class="text-muted"><i class="bi bi-circle me-1"></i> At least 8 characters</li>
                                <li id="req-upper" class="text-muted"><i class="bi bi-circle me-1"></i> Contains an uppercase letter</li>
                                <li id="req-lower" class="text-muted"><i class="bi bi-circle me-1"></i> Contains a lowercase letter</li>
                                <li id="req-number" class="text-muted"><i class="bi bi-circle me-1"></i> Contains a number</li>
                                <li id="req-special" class="text-muted"><i class="bi bi-circle me-1"></i> Contains a special character</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3 {% if form.new_password2.errors %}form-group--error{% endif %}">
                            <label for="{{ form.new_password2.id_for_label }}" class="form-label">Confirm New Password</label>
                            <div class="password-input">
                                {{ form.new_password2 }}
                                <button type="button" class="password-input__toggle" aria-label="Show password" aria-pressed="false">
                                    <i class="bi bi-eye"></i>
                                    <span class="visually-hidden">Toggle password visibility</span>
                                </button>
                            </div>
                            <small id="pwMatchText" class="text-muted d-block mt-2">Passwords must match</small>
                            {% if form.new_password2.errors %}
                                <div class="form-error mt-2">
                                    {% for error in form.new_password2.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2 mb-3">
                            <button id="submitBtn" type="submit" class="btn-gradient" disabled>
                                <i class="bi bi-check-circle me-2"></i>Reset Password
                            </button>
                        </div>
                    </form>
                    
                    <div class="text-center mt-4">
                        <p class="text-muted">
                            Remember your password? 
                            <a href="{% url 'signin' %}" class="text-decoration-none">Sign In</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    if (typeof initPasswordToggles === 'function') {
        initPasswordToggles();
    }

    const pw1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const pw2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const bar = document.getElementById('pwStrengthBar');
    const text = document.getElementById('pwStrengthText');
    const matchText = document.getElementById('pwMatchText');
    const submitBtn = document.getElementById('submitBtn');

    const reqs = {
        length: document.getElementById('req-length'),
        upper: document.getElementById('req-upper'),
        lower: document.getElementById('req-lower'),
        number: document.getElementById('req-number'),
        special: document.getElementById('req-special')
    };

    function scorePassword(p) {
        let score = 0;
        const checks = {
            length: p.length >= 8,
            upper: /[A-Z]/.test(p),
            lower: /[a-z]/.test(p),
            number: /\d/.test(p),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(p)
        };
        Object.entries(checks).forEach(([k, ok]) => {
            reqs[k].classList.toggle('valid', ok);
            if (ok) score += 20;
        });
        return score;
    }

    function update() {
        const s = scorePassword(pw1.value);
        bar.style.width = s + '%';
        if (s < 40) { bar.className = 'progress-bar bg-danger'; text.textContent = 'Strength: Too weak'; }
        else if (s < 60) { bar.className = 'progress-bar bg-warning'; text.textContent = 'Strength: Weak'; }
        else if (s < 80) { bar.className = 'progress-bar bg-info'; text.textContent = 'Strength: Good'; }
        else { bar.className = 'progress-bar bg-success'; text.textContent = 'Strength: Strong'; }

        const match = pw1.value && pw1.value === pw2.value;
        matchText.textContent = match ? 'Passwords match' : 'Passwords must match';
        matchText.className = 'text-' + (match ? 'success' : 'muted') + ' d-block mt-2';

        submitBtn.disabled = !(s >= 60 && match);
    }

    pw1.addEventListener('input', update);
    pw2.addEventListener('input', update);
    update();
});
</script>
