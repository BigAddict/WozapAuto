{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .agent-test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .test-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .test-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 300;
    }
    
    .test-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .test-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .test-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }
    
    .test-panel h3 {
        color: #495057;
        margin-bottom: 20px;
        font-size: 1.4rem;
        font-weight: 600;
    }
    
    .query-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .form-control {
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        resize: vertical;
        min-height: 120px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .response-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        min-height: 200px;
        border: 1px solid #e9ecef;
    }
    
    .response-content {
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        color: #495057;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin-top: 15px;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #c3e6cb;
        margin-top: 15px;
    }
    
    .status-panel {
        grid-column: 1 / -1;
    }
    
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .status-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        text-align: center;
    }
    
    .status-item .label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .status-item .value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-online {
        background: #28a745;
    }
    
    .status-offline {
        background: #dc3545;
    }
    
    .chat-history {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        background: white;
    }
    
    .chat-message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
    }
    
    .chat-message.user {
        background: #e3f2fd;
        margin-left: 20px;
    }
    
    .chat-message.agent {
        background: #f3e5f5;
        margin-right: 20px;
    }
    
    .chat-message .timestamp {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .chat-message .content {
        color: #495057;
        line-height: 1.5;
    }
    
    @media (max-width: 768px) {
        .test-grid {
            grid-template-columns: 1fr;
        }
        
        .test-header h1 {
            font-size: 2rem;
        }
        
        .agent-test-container {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="agent-test-container">
    <!-- Header -->
    <div class="test-header">
        <h1>ü§ñ WhatsApp AI Agent Test</h1>
        <p>Test and interact with the WhatsApp AI agent service</p>
        {% if use_mock_service %}
        <div style="background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin-top: 15px;">
            <strong>‚ö†Ô∏è Mock Service Mode:</strong> Google ADK is not available. Using mock service for demonstration purposes.
        </div>
        {% endif %}
    </div>
    
    <!-- Main Test Grid -->
    <div class="test-grid">
        <!-- Query Panel -->
        <div class="test-panel">
            <h3>üí¨ Send Query</h3>
            <form id="queryForm" class="query-form">
                <div class="form-group">
                    <label for="queryInput">Enter your message:</label>
                    <textarea 
                        id="queryInput" 
                        class="form-control" 
                        placeholder="Type your message here... (e.g., 'Hello, how can you help me?')"
                        rows="4"
                        required
                    ></textarea>
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> Send Query
                </button>
            </form>
            
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner"></div>
                <p>Processing your query...</p>
            </div>
            
            <!-- Error/Success Messages -->
            <div id="messageContainer"></div>
        </div>
        
        <!-- Response Panel -->
        <div class="test-panel">
            <h3>üìù Agent Response</h3>
            <div class="response-container">
                <div id="responseContent" class="response-content">
                    Agent responses will appear here...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat History -->
    <div class="test-panel">
        <h3>üí≠ Chat History</h3>
        <div id="chatHistory" class="chat-history">
            <p style="text-align: center; color: #6c757d; margin: 0;">
                No messages yet. Start a conversation above!
            </p>
        </div>
    </div>
</div>

<script>
// Global variables
let chatHistory = [];

// DOM elements
const queryForm = document.getElementById('queryForm');
const queryInput = document.getElementById('queryInput');
const submitBtn = document.getElementById('submitBtn');
const loadingSpinner = document.getElementById('loadingSpinner');
const responseContent = document.getElementById('responseContent');
const messageContainer = document.getElementById('messageContainer');
const chatHistoryContainer = document.getElementById('chatHistory');
const statusIndicator = document.getElementById('statusIndicator');
const statusContent = document.getElementById('statusContent');
const statusDetails = document.getElementById('statusDetails');

// CSRF token for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Utility functions
function showMessage(message, type = 'error') {
    messageContainer.innerHTML = `
        <div class="${type === 'error' ? 'error-message' : 'success-message'}">
            ${message}
        </div>
    `;
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            messageContainer.innerHTML = '';
        }, 5000);
    }
}

function clearMessage() {
    messageContainer.innerHTML = '';
}

function setLoading(loading) {
    if (loading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        loadingSpinner.style.display = 'block';
        responseContent.textContent = 'Processing your query...';
    } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Query';
        loadingSpinner.style.display = 'none';
    }
}

function addToChatHistory(query, response, timestamp) {
    chatHistory.push({ query, response, timestamp });
    
    if (chatHistory.length === 1) {
        chatHistoryContainer.innerHTML = '';
    }
    
    const messageHtml = `
        <div class="chat-message user">
            <div class="timestamp">You - ${timestamp}</div>
            <div class="content">${escapeHtml(query)}</div>
        </div>
        <div class="chat-message agent">
            <div class="timestamp">Agent - ${timestamp}</div>
            <div class="content">${escapeHtml(response)}</div>
        </div>
    `;
    
    chatHistoryContainer.insertAdjacentHTML('beforeend', messageHtml);
    chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimestamp() {
    return new Date().toLocaleTimeString();
}

// Handle form submission
queryForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const query = queryInput.value.trim();
    if (!query) {
        showMessage('Please enter a query before sending.');
        return;
    }
    
    clearMessage();
    setLoading(true);
    
    try {
        const response = await fetch('{% url "aiengine:agent_test" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query }),
        });
        
        const data = await response.json();
        
        if (data.success) {
            responseContent.textContent = data.response;
            addToChatHistory(query, data.response, formatTimestamp());
            showMessage(`Query processed successfully! Session: ${data.session_id}`, 'success');
        } else {
            responseContent.textContent = 'Error: ' + data.error;
            showMessage('Error: ' + data.error);
        }
        
    } catch (error) {
        responseContent.textContent = 'Network error: ' + error.message;
        showMessage('Network error: ' + error.message);
    } finally {
        setLoading(false);
        queryInput.value = '';
    }
});

// Auto-check status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkAgentStatus();
});
</script>
{% endblock %}
