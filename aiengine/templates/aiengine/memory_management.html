{% extends 'core/base.html' %}

{% block title %}Memory Management{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Memory Management</h1>
        <div class="btn-group">
            {% if user.is_staff %}
            <a href="{% url 'aiengine:token_dashboard' %}" class="btn btn-outline-info">
                <i class="fas fa-chart-line"></i> Token Dashboard
            </a>
            {% endif %}
            <a href="{% url 'aiengine:agent_detail' %}" class="btn btn-outline-secondary">Back to Agent</a>
        </div>
    </div>

    <!-- System Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary">{{ system_stats.total_threads|default:0 }}</h5>
                    <p class="card-text">Total Threads</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">{{ system_stats.total_messages|default:0 }}</h5>
                    <p class="card-text">Total Messages</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">{{ system_stats.messages_with_embeddings|default:0 }}</h5>
                    <p class="card-text">With Embeddings</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">{{ system_stats.recent_messages|default:0 }}</h5>
                    <p class="card-text">Recent (7 days)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Statistics -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Your Memory Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Total Conversations:</strong> {{ user_stats.total_threads|default:0 }}</p>
                    <p><strong>Total Messages:</strong> {{ user_stats.total_messages|default:0 }}</p>
                    <p><strong>User Messages:</strong> {{ user_stats.human_messages|default:0 }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>AI Messages:</strong> {{ user_stats.ai_messages|default:0 }}</p>
                    <p><strong>First Message:</strong> {{ user_stats.first_message_at|date:"M d, Y H:i"|default:"Never" }}</p>
                    <p><strong>Last Message:</strong> {{ user_stats.last_message_at|date:"M d, Y H:i"|default:"Never" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Memory Cleanup -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Memory Cleanup</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Clean up old conversations and messages to free up storage space.</p>
            
            {% if old_threads > 0 %}
            <div class="alert alert-warning">
                <strong>{{ old_threads }}</strong> old inactive threads can be cleaned up.
            </div>
            {% endif %}
            
            <form id="cleanupForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="daysOld" class="form-label">Clean up conversations older than (days)</label>
                            <input type="number" class="form-control" id="daysOld" name="days_old" value="30" min="1" max="365">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="keepRecent" class="form-label">Keep recent messages per conversation</label>
                            <input type="number" class="form-control" id="keepRecent" name="keep_recent" value="50" min="1" max="1000">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-warning" id="cleanupBtn">Clean Up Memory</button>
            </form>
            
            <div id="cleanupResults" class="mt-3" style="display: none;">
                <div id="cleanupResultsContent"></div>
            </div>
        </div>
    </div>

    <!-- Message Type Breakdown -->
    {% if system_stats.message_types %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Message Type Breakdown</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for message_type, count in system_stats.message_types.items %}
                <div class="col-md-4">
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-{% if message_type == 'human' %}primary{% elif message_type == 'ai' %}success{% else %}secondary{% endif %}">
                            {{ message_type|title }}
                        </span>
                        <strong>{{ count }}</strong>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Activity -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Recent Activity</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Recent Messages (7 days):</strong> {{ system_stats.recent_messages|default:0 }}</p>
                    <p><strong>Recent Threads (7 days):</strong> {{ system_stats.recent_threads|default:0 }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Users with Conversations:</strong> {{ system_stats.users_with_conversations|default:0 }}</p>
                    <p><strong>Agents with Conversations:</strong> {{ system_stats.agents_with_conversations|default:0 }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('cleanupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const resultsDiv = document.getElementById('cleanupResults');
    const resultsContent = document.getElementById('cleanupResultsContent');
    const cleanupBtn = document.getElementById('cleanupBtn');
    
    cleanupBtn.disabled = true;
    cleanupBtn.textContent = 'Cleaning up...';
    resultsDiv.style.display = 'block';
    resultsContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    
    fetch('{% url "aiengine:cleanup_memory" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsContent.innerHTML = `
                <div class="alert alert-success">
                    <h6>Cleanup Completed Successfully!</h6>
                    <p>${data.message}</p>
                    <hr>
                    <small>
                        <strong>Details:</strong><br>
                        Messages cleaned: ${data.stats.messages_cleaned || 0}<br>
                        Threads updated: ${data.stats.threads_updated || 0}<br>
                        Conversations cleaned: ${data.stats.conversations_cleaned || 0}
                    </small>
                </div>
            `;
        } else {
            resultsContent.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        resultsContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    })
    .finally(() => {
        cleanupBtn.disabled = false;
        cleanupBtn.textContent = 'Clean Up Memory';
    });
});
</script>
{% endblock %}
