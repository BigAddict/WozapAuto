{% extends "core/base.html" %}
{% load static %}

{% block title %}Knowledge Graph{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'aiengine:agent_details' %}">Agent Details</a></li>
<li class="breadcrumb-item"><a href="{% url 'aiengine:knowledge_base_management' %}">Knowledge Base</a></li>
<li class="breadcrumb-item active" aria-current="page">Graph View</li>
{% endblock %}

{% block extra_css %}
<style>
    .graph-container {
        width: 100%;
        height: 70vh;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
        position: relative;
        overflow: hidden;
    }

    .graph-controls {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .graph-controls .btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }

    .graph-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .stat-item {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 0.875rem;
        color: #666;
    }

    .stat-item .stat-value {
        font-weight: 600;
        color: #333;
    }

    /* D3.js Graph Styles */
    .node {
        cursor: pointer;
        stroke: #fff;
        stroke-width: 2px;
    }

    .node-pdf {
        fill: #e74c3c;
    }

    .node:hover {
        stroke: #333;
        stroke-width: 3px;
    }

    .link {
        stroke: #999;
        stroke-opacity: 0.6;
        stroke-width: 1px;
    }

    .link-explicit {
        stroke: #e74c3c;
        stroke-width: 2px;
        stroke-opacity: 0.8;
    }

    .link-similar {
        stroke: #3498db;
        stroke-opacity: 0.4;
        stroke-width: 1px;
    }

    .link-reference {
        stroke: #2ecc71;
        stroke-opacity: 0.6;
        stroke-width: 1px;
    }

    .link-tag {
        stroke: #f39c12;
        stroke-opacity: 0.7;
        stroke-width: 1px;
    }

    .node-label {
        pointer-events: none;
        font-family: sans-serif;
        font-size: 12px;
        fill: #333;
        text-anchor: middle;
        dominant-baseline: central;
    }

    .graph-tooltip {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        pointer-events: none;
        z-index: 1000;
        max-width: 300px;
    }

    .tooltip-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .tooltip-meta {
        color: #666;
        font-size: 12px;
        margin-bottom: 2px;
    }

    .tooltip-content {
        color: #555;
        font-size: 12px;
        margin-top: 6px;
        max-height: 100px;
        overflow-y: auto;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .empty-state-text {
        color: #666;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .graph-container {
            height: 60vh;
        }

        .graph-controls {
            flex-direction: column;
            gap: 0.5rem;
        }

        .graph-controls .btn {
            width: 100%;
            justify-content: center;
        }

        .graph-stats {
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-item {
            text-align: center;
        }

        .node-label {
            font-size: 10px;
        }

        .graph-tooltip {
            max-width: 250px;
            font-size: 12px;
        }
    }

    @media (max-width: 480px) {
        .graph-container {
            height: 50vh;
        }

        .node-label {
            font-size: 9px;
        }

        .graph-tooltip {
            max-width: 200px;
            font-size: 11px;
            padding: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1><i class="bi bi-diagram-3"></i> Knowledge Graph</h1>
                    <p class="text-muted mb-0">Interactive visualization of your knowledge base relationships</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'aiengine:knowledge_base_management' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Knowledge Base
                    </a>
                </div>
            </div>

            <!-- Graph Stats -->
            <div class="graph-stats" id="graph-stats" style="display: none;">
                <div class="stat-item">
                    <span class="stat-value" id="node-count">0</span> Nodes
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="edge-count">0</span> Connections
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="similarity-count">0</span> Similarity Links
                </div>
            </div>

            <!-- Graph Controls -->
            <div class="graph-controls">
                <button id="reset-view" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Reset View
                </button>
                <button id="toggle-similarity" class="btn btn-outline-primary">
                    <i class="bi bi-link-45deg"></i> Toggle Similarity Links
                </button>
                <button id="center-graph" class="btn btn-outline-info">
                    <i class="bi bi-arrows-move"></i> Center Graph
                </button>
                <button id="export-graph" class="btn btn-outline-success">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>

            <!-- Graph Container -->
            <div id="graph-container" class="graph-container">
                <div class="loading-overlay" id="loading-overlay">
                    <div class="text-center">
                        <div class="loading-spinner"></div>
                        <div class="mt-2">Loading graph...</div>
                    </div>
                </div>
                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="bi bi-diagram-3"></i>
                    </div>
                    <div class="empty-state-title">No Knowledge Base Data</div>
                    <div class="empty-state-text">
                        Upload some documents to your knowledge base to see the graph visualization.
                        <br>
                        <a href="{% url 'aiengine:knowledge_base_management' %}" class="btn btn-primary btn-sm mt-2">
                            <i class="bi bi-upload"></i> Upload Documents
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
class KnowledgeGraph {
    constructor(containerId, dataUrl) {
        this.containerId = containerId;
        this.dataUrl = dataUrl;
        this.graphData = null;
        this.showSimilarityLinks = true;
        this.simulation = null;
        this.svg = null;
        this.g = null;
        this.tooltip = null;
        this.init();
    }
    
    async init() {
        await this.loadData();
        if (this.graphData && this.graphData.nodes.length > 0) {
            this.createGraph();
            this.setupEventListeners();
            this.updateStats();
        } else {
            this.showEmptyState();
        }
    }
    
    async loadData() {
        try {
            const response = await fetch(this.dataUrl);
            this.graphData = await response.json();
            console.log('Graph data loaded:', this.graphData);
            
            // Check for errors in the response
            if (this.graphData.error) {
                console.error('Graph data error:', this.graphData.error);
                this.showEmptyState();
                return;
            }
            
            // Check if we have any nodes
            if (!this.graphData.nodes || this.graphData.nodes.length === 0) {
                console.log('No nodes found in graph data');
                this.showEmptyState();
                return;
            }
            
        } catch (error) {
            console.error('Error loading graph data:', error);
            this.showEmptyState();
        }
    }
    
    createGraph() {
        const container = d3.select(`#${this.containerId}`);
        container.html(''); // Clear previous content
        
        const width = container.node().getBoundingClientRect().width;
        const height = container.node().getBoundingClientRect().height;
        
        // Hide loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        
        this.svg = container.append('svg')
            .attr('width', width)
            .attr('height', height);
        
        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                this.g.attr('transform', event.transform);
            });
        
        this.svg.call(zoom);
        
        this.g = this.svg.append('g');
        
        // Create simulation
        this.simulation = d3.forceSimulation(this.graphData.nodes)
            .force('charge', d3.forceManyBody().strength(-1000))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(50));
        
        // Only add link force if we have edges
        if (this.graphData.edges && this.graphData.edges.length > 0) {
            this.simulation.force('link', d3.forceLink(this.graphData.edges).id(d => d.id).distance(100));
        }
        
        // Create edges (only if we have edges)
        let link = null;
        if (this.graphData.edges && this.graphData.edges.length > 0) {
            link = this.g.append('g')
                .selectAll('line')
                .data(this.graphData.edges)
                .enter().append('line')
                .attr('class', d => `link link-${d.type.toLowerCase()}`)
                .style('stroke-width', d => Math.max(1, d.strength * 3));
        }
        
        // Create nodes
        const node = this.g.append('g')
            .selectAll('circle')
            .data(this.graphData.nodes)
            .enter().append('circle')
            .attr('r', d => this.getNodeSize(d))
            .attr('class', d => `node node-${d.file_type}`)
            .call(d3.drag()
                .on('start', this.dragStarted.bind(this))
                .on('drag', this.dragged)
                .on('end', this.dragEnded.bind(this)));
        
        // Add labels
        const label = this.g.append('g')
            .selectAll('text')
            .data(this.graphData.nodes)
            .enter().append('text')
            .text(d => this.truncateText(d.name, 15))
            .attr('class', 'node-label')
            .style('font-size', '12px')
            .style('text-anchor', 'middle')
            .style('dy', '0.35em');
        
        // Create tooltip
        this.tooltip = d3.select('body').append('div')
            .attr('class', 'graph-tooltip')
            .style('opacity', 0)
            .style('position', 'absolute')
            .style('pointer-events', 'none');
        
        // Add hover effects
        node.on('mouseover', (event, d) => {
            this.tooltip.transition().duration(200).style('opacity', 0.9);
            this.tooltip.html(this.createTooltipContent(d))
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', () => {
            this.tooltip.transition().duration(500).style('opacity', 0);
        });
        
        // Update positions
        this.simulation.on('tick', () => {
            if (link) {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
            }
            
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
            
            label
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });
    }
    
    getNodeSize(node) {
        // Base size with variation based on content length
        const baseSize = 8;
        const contentLength = node.content_preview ? node.content_preview.length : 0;
        return Math.max(baseSize, Math.min(20, baseSize + (contentLength / 50)));
    }
    
    truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    createTooltipContent(node) {
        return `
            <div class="tooltip-title">${node.name}</div>
            <div class="tooltip-meta">
                <strong>Type:</strong> ${node.file_type.toUpperCase()}
            </div>
            <div class="tooltip-meta">
                <strong>Created:</strong> ${new Date(node.created_at).toLocaleDateString()}
            </div>
            ${node.original_filename ? `<div class="tooltip-meta"><strong>File:</strong> ${node.original_filename}</div>` : ''}
            ${node.content_preview ? `<div class="tooltip-content">${node.content_preview}...</div>` : ''}
        `;
    }
    
    dragStarted(event, d) {
        if (!event.active) this.simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    
    dragEnded(event, d) {
        if (!event.active) this.simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
    
    setupEventListeners() {
        document.getElementById('reset-view').addEventListener('click', () => {
            this.simulation.alphaTarget(0.3).restart();
        });
        
        document.getElementById('toggle-similarity').addEventListener('click', () => {
            this.showSimilarityLinks = !this.showSimilarityLinks;
            d3.selectAll('.link-similar')
                .style('display', this.showSimilarityLinks ? 'block' : 'none');
            
            // Update button text
            const btn = document.getElementById('toggle-similarity');
            const icon = this.showSimilarityLinks ? 'bi-link-45deg' : 'bi-link-45deg-slash';
            btn.innerHTML = `<i class="bi ${icon}"></i> ${this.showSimilarityLinks ? 'Hide' : 'Show'} Similarity Links`;
        });
        
        document.getElementById('center-graph').addEventListener('click', () => {
            this.centerGraph();
        });
        
        document.getElementById('export-graph').addEventListener('click', () => {
            this.exportGraph();
        });
    }
    
    centerGraph() {
        if (!this.svg || !this.g) return;
        
        const width = this.svg.node().getBoundingClientRect().width;
        const height = this.svg.node().getBoundingClientRect().height;
        
        this.svg.transition()
            .duration(750)
            .call(
                d3.zoom().transform,
                d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
            );
    }
    
    exportGraph() {
        if (!this.svg) return;
        
        // Create a copy of the SVG
        const svgData = new XMLSerializer().serializeToString(this.svg.node());
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const svgUrl = URL.createObjectURL(svgBlob);
        
        // Create download link
        const downloadLink = document.createElement('a');
        downloadLink.href = svgUrl;
        downloadLink.download = 'knowledge-graph.svg';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(svgUrl);
    }
    
    updateStats() {
        if (!this.graphData) return;
        
        const similarityCount = this.graphData.edges.filter(e => e.type === 'SIMILAR').length;
        
        document.getElementById('node-count').textContent = this.graphData.total_nodes;
        document.getElementById('edge-count').textContent = this.graphData.total_edges;
        document.getElementById('similarity-count').textContent = similarityCount;
        document.getElementById('graph-stats').style.display = 'flex';
    }
    
    showEmptyState() {
        const loadingOverlay = document.getElementById('loading-overlay');
        const emptyState = document.getElementById('empty-state');
        
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        if (emptyState) {
            emptyState.style.display = 'block';
        }
    }
}

// Initialize graph when page loads
document.addEventListener('DOMContentLoaded', function() {
    const graph = new KnowledgeGraph('graph-container', '{{ graph_data_url }}');
});
</script>
{% endblock %}
