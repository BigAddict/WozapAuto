{% extends 'core/base.html' %}
{% load static %}

{% block title %}Connect WhatsApp - WozapAuto{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if retry_info.max_retries_reached and not retry_info.can_retry %}
        <!-- Help Needed State -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>Connection Help Needed
                        </h4>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-4">
                            <i class="bi bi-headset" style="font-size: 4rem; color: #ffc107;"></i>
                        </div>
                        <p class="lead">We're having trouble connecting your WhatsApp account.</p>
                        <p>Our support team has been notified and will contact you soon.</p>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            You can try again in 2 hours, or contact support for immediate assistance.
                        </div>
                        <button class="btn btn-primary" onclick="sendHelpRequest()">
                            <i class="bi bi-headset me-2"></i>Request Help
                        </button>
                    </div>
                </div>
            </div>
        </div>
    
    {% elif qr_error %}
        <!-- Error State -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-exclamation-circle me-2"></i>Connection Error
                        </h4>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-4">
                            <i class="bi bi-wifi-off" style="font-size: 4rem; color: #dc3545;"></i>
                        </div>
                        <p class="lead">Unable to generate QR code</p>
                        <div class="alert alert-danger">
                            <strong>Error:</strong> {{ qr_error }}
                        </div>
                        <a href="{% url 'connections:create' %}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-2"></i>Try Again
                        </a>
                    </div>
                </div>
            </div>
        </div>
    
    {% else %}
        <!-- QR Code Display State -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-whatsapp me-2"></i>Connect Your WhatsApp
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Progress Indicator -->
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="connectionProgress"></div>
                        </div>
                        
                        <!-- Connection Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6><i class="bi bi-building me-2"></i>Company</h6>
                                <p class="text-muted">{{ connection.instance_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-whatsapp me-2"></i>WhatsApp Number</h6>
                                <p class="text-muted">{{ connection.ownerPhone }}</p>
                            </div>
                        </div>
                        
                        <!-- QR Code Display -->
                        <div class="text-center mb-4">
                            <h5>Scan QR Code with WhatsApp</h5>
                            <div class="qr-code-container mb-3">
                                {% if qr_code_data.base64 %}
                                    <img src="{{ qr_code_data.base64 }}" 
                                         alt="WhatsApp QR Code" 
                                         class="img-fluid border rounded" 
                                         style="max-width: 300px; max-height: 300px;">
                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        QR code not available
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Pairing Code -->
                            {% if qr_code_data.pairing_code and qr_code_data.pairing_code != 'N/A' %}
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="bi bi-key me-2"></i>
                                            <strong>Or use pairing code:</strong> 
                                            <code class="fs-5" id="pairingCode">{{ qr_code_data.pairing_code }}</code>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="copyPairingCodeBtn" onclick="copyPairingCode()" title="Copy pairing code">
                                            <i class="bi bi-clipboard me-1"></i>Copy
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- QR Code Request Information -->
                        {% if retry_info.qr_code_requests > 0 %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            QR code request {{ retry_info.qr_code_requests }} of 5
                        </div>
                        {% endif %}
                        
                        <!-- Manual Controls -->
                        <div class="text-center mb-4">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" id="getNewQrBtn" onclick="getNewQRCode()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Get New QR Code
                                </button>
                                <button type="button" class="btn btn-success" id="connectionCompleteBtn" onclick="checkConnectionCompleteWithDelay()">
                                    <i class="bi bi-check-circle me-2"></i>Connection Complete
                                </button>
                            </div>
                        </div>
                        
                        <!-- Status Messages -->
                        <div id="statusMessages" class="mt-3"></div>
                        
                        <!-- Instructions -->
                        <div class="alert alert-light">
                            <h6><i class="bi bi-info-circle me-2"></i>Instructions:</h6>
                            <ol class="mb-0">
                                <li>Open WhatsApp on your phone</li>
                                <li>Go to Settings > Linked Devices</li>
                                <li>Tap "Link a Device"</li>
                                <li>Scan the QR code above or enter the pairing code</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<script>
// Manual QR code management JavaScript
let qrRequestCount = {{ retry_info.qr_code_requests|default:0 }};


function getNewQRCode() {
    const btn = document.getElementById('getNewQrBtn');
    const connectionBtn = document.getElementById('connectionCompleteBtn');
    
    // Disable only the QR button during fetch
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Getting QR Code...';
    
    showStatusMessage('Requesting new QR code...', 'info');
    
    fetch('{% url "connections:qr_request_api" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            qrRequestCount = data.qr_code_requests;
            
            // Update QR code
            const qrImg = document.querySelector('.qr-code-container img');
            if (qrImg && data.qr_code_data.base64) {
                qrImg.src = data.qr_code_data.base64;
            }
            
            // Update pairing code
            const pairingCodeElement = document.getElementById('pairingCode');
            if (pairingCodeElement && data.qr_code_data.pairing_code && data.qr_code_data.pairing_code !== 'N/A') {
                pairingCodeElement.textContent = data.qr_code_data.pairing_code;
            }
            
            // Update QR request info
            if (data.qr_code_requests > 0) {
                const qrAlert = document.querySelector('.alert-info');
                if (qrAlert) {
                    qrAlert.innerHTML = `<i class="bi bi-info-circle me-2"></i>QR code request ${data.qr_code_requests} of 5`;
                }
            }
            
            showStatusMessage('New QR code generated! Scan it with WhatsApp.', 'success');
            
            // Reset connection button if it was in failed state
            if (connectionBtn.disabled && connectionBtn.innerHTML.includes('Connection Failed')) {
                connectionBtn.disabled = false;
                connectionBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Connection Complete';
            }
            
            // Check if max requests reached
            if (data.qr_code_requests >= 5) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-clock me-2"></i>Wait 2 Hours';
                showStatusMessage('Maximum QR code requests reached. Please wait 2 hours before requesting again.', 'warning');
            }
        } else {
            showStatusMessage('Failed to get new QR code: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showStatusMessage('Error getting QR code: ' + error.message, 'danger');
    })
    .finally(() => {
        if (qrRequestCount < 5) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Get New QR Code';
        }
    });
}

function checkConnectionCompleteWithDelay() {
    const connectionBtn = document.getElementById('connectionCompleteBtn');
    const qrBtn = document.getElementById('getNewQrBtn');
    
    // Disable both buttons at start
    connectionBtn.disabled = true;
    qrBtn.disabled = true;
    
    // Start the retry process
    attemptConnectionCheck(1, 3);
}

function attemptConnectionCheck(attempt, maxAttempts) {
    const connectionBtn = document.getElementById('connectionCompleteBtn');
    const qrBtn = document.getElementById('getNewQrBtn');
    const progress = document.getElementById('connectionProgress');
    
    // Show attempt info
    connectionBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Attempt ${attempt} of ${maxAttempts} - Waiting 20s...`;
    showStatusMessage(`Checking connection... Attempt ${attempt} of ${maxAttempts}`, 'info');
    
    let remaining = 20;
    const interval = setInterval(() => {
        remaining -= 1;
        const pct = Math.round(((attempt - 1) * 33.33) + ((20 - remaining) / 20) * 33.33);
        if (progress) progress.style.width = pct + '%';
        connectionBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Attempt ${attempt} of ${maxAttempts} - Waiting ${remaining}s...`;
        
        if (remaining <= 0) {
            clearInterval(interval);
            connectionBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Attempt ${attempt} of ${maxAttempts} - Checking...`;
            
            fetch('{% url "connections:status_api" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.connection_status === 'open') {
                            showStatusMessage('Connection successful! Redirecting...', 'success');
                            if (progress) progress.style.width = '100%';
                            setTimeout(() => { window.location.href = '{% url "connections:detail" %}'; }, 1500);
                            return; // Exit early on success
                        } else {
                            // Connection not established yet
                            if (attempt < maxAttempts) {
                                showStatusMessage(`Connection not detected. Retrying in 20 seconds... (${attempt}/${maxAttempts})`, 'warning');
                                setTimeout(() => attemptConnectionCheck(attempt + 1, maxAttempts), 1000);
                            } else {
                                // All attempts failed
                                handleConnectionFailure();
                            }
                        }
                    } else {
                        // API error
                        if (attempt < maxAttempts) {
                            showStatusMessage(`Error checking status: ${data.message}. Retrying... (${attempt}/${maxAttempts})`, 'warning');
                            setTimeout(() => attemptConnectionCheck(attempt + 1, maxAttempts), 1000);
                        } else {
                            handleConnectionFailure();
                        }
                    }
                })
                .catch(error => {
                    // Network error
                    if (attempt < maxAttempts) {
                        showStatusMessage(`Network error: ${error.message}. Retrying... (${attempt}/${maxAttempts})`, 'warning');
                        setTimeout(() => attemptConnectionCheck(attempt + 1, maxAttempts), 1000);
                    } else {
                        handleConnectionFailure();
                    }
                });
        }
    }, 1000);
}

function handleConnectionFailure() {
    const connectionBtn = document.getElementById('connectionCompleteBtn');
    const qrBtn = document.getElementById('getNewQrBtn');
    const progress = document.getElementById('connectionProgress');
    
    // Keep connection button disabled
    connectionBtn.disabled = true;
    connectionBtn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Connection Failed (3 attempts)';
    
    // Re-enable QR code button as recovery option
    qrBtn.disabled = false;
    qrBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Get New QR Code';
    
    // Reset progress bar
    if (progress) progress.style.width = '0%';
    
    // Show helpful message
    showStatusMessage('Connection not detected after 3 attempts. Please try getting a new QR code or request help if the issue persists.', 'danger');
}

function sendHelpRequest() {
    fetch('{% url "connections:help_api" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showStatusMessage(data.message, 'success');
        } else {
            showStatusMessage('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showStatusMessage('Error: ' + error.message, 'danger');
    });
}

function showStatusMessage(message, type) {
    const statusDiv = document.getElementById('statusMessages');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
}

// Set up page initialization
document.addEventListener('DOMContentLoaded', function() {
    // Check if max QR requests reached on page load
    if (qrRequestCount >= 5) {
        const btn = document.getElementById('getNewQrBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-clock me-2"></i>Wait 2 Hours';
        }
    }
});

// Copy pairing code functionality
function copyPairingCode() {
    const pairingCodeElement = document.getElementById('pairingCode');
    const copyBtn = document.getElementById('copyPairingCodeBtn');
    
    if (!pairingCodeElement) {
        showStatusMessage('Pairing code not available', 'error');
        return;
    }
    
    const pairingCode = pairingCodeElement.textContent.trim();
    
    // Use the modern Clipboard API if available
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(pairingCode).then(() => {
            showCopySuccess(copyBtn);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopyTextToClipboard(pairingCode, copyBtn);
        });
    } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyTextToClipboard(pairingCode, copyBtn);
    }
}

// Fallback copy function for older browsers
function fallbackCopyTextToClipboard(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    
    // Avoid scrolling to bottom
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(button);
        } else {
            showStatusMessage('Failed to copy pairing code', 'error');
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        showStatusMessage('Failed to copy pairing code', 'error');
    }
    
    document.body.removeChild(textArea);
}

// Show copy success feedback
function showCopySuccess(button) {
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');
    
    showStatusMessage('Pairing code copied to clipboard!', 'success');
    
    // Reset button after 2 seconds
    setTimeout(() => {
        button.innerHTML = originalContent;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-primary');
    }, 2000);
}
</script>

<style>

.qr-code-container {
    background: white;
    border-radius: 15px;
    padding: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: inline-block;
}

.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.alert-info code {
    background: rgba(13, 110, 253, 0.1);
    color: #0d6efd;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 600;
}

/* Copy button styling */
#copyPairingCodeBtn {
    transition: all 0.2s ease;
    border: 1px solid #0d6efd;
    color: #0d6efd;
    background: transparent;
}

#copyPairingCodeBtn:hover {
    background: #0d6efd;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

#copyPairingCodeBtn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(13, 110, 253, 0.3);
}

/* Pairing code container styling */
.alert-info .d-flex {
    gap: 1rem;
}

@media (max-width: 576px) {
    .alert-info .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 0.5rem;
    }
    
    #copyPairingCodeBtn {
        align-self: flex-end;
    }
}

@media (max-width: 768px) {
    .qr-code-container img {
        max-width: 250px !important;
        max-height: 250px !important;
    }
    
}
</style>
{% endblock %}
